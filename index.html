<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Good Luck Optical - Delivery Entry</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Flatpickr -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #dcd8ff, #f2e9ff, #e4d4ff);
    background-size: 400% 400%;
    animation: gradientMove 10s ease infinite;
    padding: 0;
    margin: 0;
  }
  @keyframes gradientMove {
    0% { background-position: 0% 0%; }
    50% { background-position: 100% 100%; }
    100% { background-position: 0% 0%; }
  }

  nav {
    position: fixed;
    top: 0;
    left: 0; right: 0;
    background: #ffffffcc;
    backdrop-filter: blur(8px);
    padding: 1.2rem 1rem;
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    font-size: 1.4rem;
    z-index: 100;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  nav button {
    background: #5e38ee;
    border: none;
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 14px;
    color: white;
    font-weight: 600;
  }

  .form-container {
    margin-top: 110px;
    background: #fff;
    border-radius: 16px;
    padding: 28px 20px;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 8px 25px rgba(0,0,0,0.07);
  }

  h2 {
    text-align: center;
    font-weight: 700;
    color: #3a2e6f;
    margin-bottom: 22px;
  }

  /* Floating Input Wrapper */
  .input-group {
    position: relative;
    margin-bottom: 22px;
  }

  .input-group input,
  .input-group select {
    width: 100%;
    padding: 16px 12px 10px 12px;
    border: 1.6px solid #c9c4ff;
    border-radius: 10px;
    font-size: 16px;
    background: #fff;
  }

  .input-group label {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    transition: 0.2s ease;
    pointer-events: none;
    background: #fff;
    padding: 0 6px;
    color: #777;
  }

  /* When typing */
  .input-group input:focus,
  .input-group select:focus {
    border-color: #5e38ee;
    box-shadow: 0 0 0 3px rgba(94,56,238,0.2);
    outline: none;
  }

  /* Floating label animation */
  .input-group input:focus + label,
  .input-group input:not(:placeholder-shown) + label,
  .input-group select:focus + label,
  .input-group select:not([value=""]) + label {
    top: -6px;
    font-size: 12px;
    color: #5e38ee;
  }

  .submit-btn {
    background: #5e38ee;
    padding: 14px;
    width: 100%;
    color: white;
    border-radius: 10px;
    font-size: 17px;
    font-weight: 600;
    border: none;
    margin-top: 10px;
  }
  .submit-btn:hover {
    background: #4720d6;
  }

  /* Flatpickr Custom Look */
  .flatpickr-calendar {
    border-radius: 12px !important;
    box-shadow: 0 12px 30px rgba(0,0,0,0.15) !important;
  }
  .flatpickr-day.selected {
    background: #5e38ee !important;
    border-color: #5e38ee !important;
  }
  .flatpickr-day.today {
    border-color: #a992ff !important;
  }
</style>
</head>

<body>

<nav>
  Good Luck Optical
  <button id="updateOrderBtn">Update</button>
</nav>

<div class="form-container">
  <h2>Delivery Entry</h2>

  <div class="input-group">
    <input id="delivery" type="text" placeholder=" " readonly />
    <label>Delivery Date</label>
  </div>

  <div class="input-group">
    <input id="orderNo" type="text" placeholder=" " />
    <label>Order No</label>
  </div>

  <div class="input-group">
    <input id="orderDate" type="text" placeholder=" " readonly />
    <label>Order Date</label>
  </div>

  <div class="input-group">
    <input id="docsp" type="text" placeholder=" " />
    <label>Doc / Sp</label>
  </div>

  <div class="input-group">
    <input id="customername" type="text" placeholder=" " />
    <label>Customer Name</label>
  </div>

  <div class="input-group">
    <input id="phone" type="tel" placeholder=" " maxlength="10" />
    <label>Phone</label>
  </div>

  <div class="input-group">
    <input id="total" type="number" placeholder=" " />
    <label>Total</label>
  </div>

  <div class="input-group">
    <input id="adv" type="number" placeholder=" " />
    <label>Advance</label>
  </div>

  <div class="input-group">
    <select id="frame">
      <option value=""></option>
      <option>Black Shell</option>
      <option>Violet Metal</option>
      <option>Gold Frame</option>
      <option>Silver Round</option>
      <option>Plastic Full Rim</option>
    </select>
    <label>Frame</label>
  </div>

  <div class="input-group">
    <select id="lens">
      <option value=""></option>
      <option>Prog HC</option>
      <option>CR + CL Yearly</option>
      <option>Blue Cut</option>
      <option>Photochromatic</option>
      <option>Progressive</option>
    </select>
    <label>Lens</label>
  </div>

  <div class="input-group">
    <input id="sent" type="text" placeholder=" " readonly />
    <label>Sent Date/Time</label>
  </div>

  <div class="input-group">
    <input id="rec" type="text" placeholder=" " readonly />
    <label>Received Date/Time</label>
  </div>

  <div class="input-group">
    <select id="informed">
      <option value=""></option>
      <option>Yes - Done</option>
      <option>No - Pending</option>
    </select>
    <label>Informed</label>
  </div>

  <div class="input-group">
    <select id="feedback">
      <option value=""></option>
      <option>Done</option>
      <option>Pending</option>
      <option>Not Needed</option>
    </select>
    <label>Feedback</label>
  </div>

  <button class="submit-btn" onclick="submitData()">Submit</button>
</div>


  <!-- Response Modal -->
  <div class="modal fade" id="responseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Message</h5></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Order Modal -->
  <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Update Order</h5></div>
        <div class="modal-body">
          <input type="text" id="fetchOrderNo" class="form-control" placeholder="Enter Order No" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" id="fetchOrderBtn">Fetch</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Only showing modified/added JS for clarity; the HTML stays mostly same -->

<script>
// =========================
//  INIT
// =========================
flatpickr("#delivery, #orderDate, #sent, #rec", { 
  dateFormat: "d M Y"
});

const scriptURL = "https://script.google.com/macros/s/AKfycbxEnatWkI8lWiWlaiS4KeLt4OCPdeEac-OS2cu41TSDJ859ZPjAc2varv8eX-2S5Amh/exec";
const responseModal = new bootstrap.Modal(document.getElementById('responseModal'));
const updateModal   = new bootstrap.Modal(document.getElementById('updateModal'));

let isUpdate = false;

// =========================
// UI Helpers
// =========================
function markInvalid(id, valid) {
  const el = document.getElementById(id);
  const label = el.previousElementSibling;

  if (!valid) {
    el.style.borderColor = "#ff3b3b";
    label.style.color = "#ff3b3b";
  } else {
    el.style.borderColor = "";
    label.style.color = "";
  }
}

// =========================
// Fetch Order (Update Mode)
// =========================
document.getElementById("updateOrderBtn").addEventListener("click", () => updateModal.show());
document.getElementById("fetchOrderBtn").addEventListener("click", fetchOrder);

async function fetchOrder() {
  const orderNum = document.getElementById("fetchOrderNo").value.trim();

  if (!orderNum) return alert("Enter Order No da.");

  const payload = { action: "getOrder", orderNo: orderNum };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!data.row) return alert("Order not found.");

    const row = data.row;

    // Fill values
    [
      "delivery","orderNo","orderDate","docsp","customername","phone",
      "total","adv","frame","lens","sent","rec","informed","feedback"
    ].forEach((id, i) => {
      document.getElementById(id).value = row[i] || "";
    });

    isUpdate = true;
    updateModal.hide();

  } catch (err) {
    console.error(err);
    alert("Server Error. Try again.");
  }
}

// =========================
// Form Validation
// =========================
async function validateForm() {
  let ok = true;

  const requiredIds = [
    "delivery","orderNo","orderDate","docsp","customername","phone",
    "total","adv","frame","lens","sent"
  ];

  requiredIds.forEach(id => {
    const valid = document.getElementById(id).value.trim() !== "";
    markInvalid(id, valid);
    if (!valid) ok = false;
  });

  // If new entry â†’ check duplicate
  if (!isUpdate && ok) {
    const payload = { action: "checkOrder", orderNo: orderNo.value.trim() };

    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();

      if (result.exists) {
        markInvalid("orderNo", false);
        alert("Order number already exists.");
        ok = false;
      }

    } catch (err) {
      alert("Validation failed.");
      return false;
    }
  }

  return ok;
}

// =========================
// Submit Data
// =========================
async function submitData() {
  const valid = await validateForm();
  if (!valid) return;

  const payload = {
    delivery: delivery.value,
    orderNo: orderNo.value,
    date: orderDate.value,
    docsp: docsp.value,
    customername: customername.value,
    phone: phone.value,
    total: total.value,
    adv: adv.value,
    frame: frame.value,
    lens: lens.value,
    sent: sent.value,
    rec: rec.value,
    informed: informed.value,
    feedback: feedback.value,
    action: isUpdate ? "update" : "new"
  };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    isUpdate = false;

    document.getElementById("modalBody").textContent =
      result.status === "success" ? 
      (payload.action === "new" ? "Order Added Successfully!" : "Order Updated Successfully!") :
      result.message || "Operation failed";

    responseModal.show();

  } catch (err) {
    console.error(err);
    document.getElementById("modalBody").textContent = "Network Error. Try again.";
    responseModal.show();
  }
}
</script>


</body>
</html>
